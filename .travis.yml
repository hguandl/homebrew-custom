language: shell

os: osx
osx_image: xcode11.3

before_install:
  - source ./precondition.sh
  - if [ -z ${DO_BUILD} ]; then travis_terminate 0; fi
  - git config --global user.name ${GITHUB_USERNAME}
  - git config --global user.email ${GITHUB_EMAIL}
  - echo -e "machine github.com\n  login ${GITHUB_USERNAME}\n  password ${GITHUB_TOKEN}" > ~/.netrc
  - echo -e "machine api.bintray.com\n  login ${BINTRAY_USERNAME}\n  password ${BINTRAY_KEY}" >> ~/.netrc

install:
  - brew update
  - brew upgrade
  - brew tap hguandl/custom

script:
  - travis_wait 120 brew install hguandl/custom/${TARGET_FORMULA} --build-bottle

before_cache:
  - brew cleanup

cache:
  directories:
  - "/usr/local/Homebrew"
  - "$HOME/Library/Caches/pip"
  - "$HOME/Library/Caches/Homebrew"

before_deploy:
  - brew update
  - brew bottle --json ${TARGET_FORMULA} --root-url ${BOTTLE_ROOT_URL} || brew bottle --skip-relocation --json ${TARGET_FORMULA} --root-url ${BOTTLE_ROOT_URL}
  - brew bottle --merge --write $(ls ${TARGET_FORMULA}*bottle*.json)
  - pip3 install requests

deploy:
  - provider: script
    cleanup: false
    script: ./deploy-tap.sh ${TARGET_FORMULA}
    on:
      branch: master
    edge: true

after_deploy:
  - brew update
