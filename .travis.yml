language: shell

os: osx
osx_image: xcode11.3
env: BINTRAY_VERSION=latest

jobs:
  include:
    - stage: "Precondition"
      name: "Check for updated formulae"
      script: export TARGET_FORMULA=$(echo ${TRAVIS_COMMIT_MESSAGE} | cut -f 1 -d ":")
                ./precondition.sh
                if [ -e .DO_BUILD ]; then; export DO_BUILD=1; fi
    - stage: "Preparation"
      name: "Prepare for building"
      script: git config --global user.name ${GITHUB_USERNAME}
                git config --global user.email ${GITHUB_EMAIL}
                echo -e "machine github.com\n  login ${GITHUB_USERNAME}\n  password ${GITHUB_TOKEN}" > ~/.netrc
                echo -e "machine api.bintray.com\n  login ${BINTRAY_USERNAME}\n  password ${BINTRAY_KEY}" >> ~/.netrc
    - stage: "Setup"
      name: "Setup workspace"
      script: brew update && brew upgrade
    - stage "Build"
      name: "Build formula"
      script: travis_wait 120 brew install hguandl/custom/${TARGET_FORMULA} --build-bottle
    - stage "Package"
      name: "Package formula"
      script: brew update
                brew bottle --json ${TARGET_FORMULA} --root-url ${BOTTLE_ROOT_URL} || brew bottle --skip-relocation --json ${TARGET_FORMULA} --root-url ${BOTTLE_ROOT_URL}
                brew bottle --merge --write $(ls ${TARGET_FORMULA}*bottle*.json)
                pip3 install requests
    - stage "Deploy"
      name: "Deploy to tap"
      script: ./deploy-tap.sh ${TARGET_FORMULA}

stages:
  - name: precondition
  - name: before_install
    if: env(DO_BUILD) = 1
  - name: install
    if: env(DO_BUILD) = 1
  - name: script
    if: env(DO_BUILD) = 1
  - name: before_deploy
    if: env(DO_BUILD) = 1
  - name: deploy
    if: env(DO_BUILD) = 1
  - name: after_deploy
    if: (env(DO_BUILD) = 1) AND (branch = master)

before_cache:
  - brew update
  - brew cleanup

cache:
  directories:
  - "/usr/local/Homebrew"
  - "$HOME/Library/Caches/pip"
  - "$HOME/Library/Caches/Homebrew"
